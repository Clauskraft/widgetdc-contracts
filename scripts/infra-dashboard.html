<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Infrastructure Intelligence — WidgeTDC</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background: #0b0e14; color: #e2e8f0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

  /* Top bar */
  #topbar { display: flex; align-items: center; gap: 16px; padding: 10px 20px; border-bottom: 1px solid #1a1f2e; background: #0f1219; flex-shrink: 0; }

  /* Board selector */
  .board-selector { display: flex; gap: 2px; background: #0a0d12; border: 1px solid #1a1f2e; border-radius: 8px; padding: 3px; }
  .board-btn { padding: 7px 16px; font-size: 12px; border-radius: 6px; text-decoration: none; color: #475569; font-weight: 600; transition: all 0.2s; white-space: nowrap; }
  .board-btn.active { background: #1e293b; color: #f1f5f9; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
  .board-btn:hover:not(.active) { color: #94a3b8; background: #141824; }

  /* Tabs */
  .tabs { display: flex; gap: 2px; margin-left: auto; background: #141824; border-radius: 6px; padding: 2px; flex-wrap: wrap; }
  .tab-btn { padding: 5px 14px; font-size: 11px; border-radius: 4px; border: none; background: transparent; color: #64748b; cursor: pointer; font-weight: 500; transition: all 0.15s; font-family: inherit; }
  .tab-btn.active { background: #06b6d4; color: #fff; }
  .tab-btn:hover:not(.active) { color: #94a3b8; background: #1a1f2e; }

  /* Main content */
  #main { flex: 1; overflow-y: auto; padding: 20px; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Grid system */
  .grid { display: grid; gap: 16px; }
  .grid-2 { grid-template-columns: 1fr 1fr; }
  .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
  .grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
  .grid-5 { grid-template-columns: 1fr 1fr 1fr 1fr 1fr; }

  /* Cards */
  .card { background: #141824; border: 1px solid #1a1f2e; border-radius: 8px; padding: 16px; }
  .card-lg { padding: 20px; border-radius: 10px; }
  .card-title { font-size: 10px; text-transform: uppercase; letter-spacing: 0.06em; color: #64748b; font-weight: 600; margin-bottom: 8px; }
  .kpi-val { font-size: 28px; font-weight: 700; color: #f1f5f9; line-height: 1; }
  .kpi-lbl { font-size: 11px; color: #64748b; margin-top: 4px; }
  .card-value { font-size: 32px; font-weight: 700; color: #f1f5f9; line-height: 1; }
  .card-value.sm { font-size: 22px; }
  .card-sub { font-size: 11px; color: #475569; margin-top: 4px; }

  /* Badges */
  .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
  .badge-active { background: rgba(34,197,94,0.15); color: #22c55e; }
  .badge-deploying { background: rgba(245,158,11,0.15); color: #f59e0b; }
  .badge-crashed { background: rgba(239,68,68,0.15); color: #ef4444; }
  .badge-unknown { background: rgba(100,116,139,0.15); color: #64748b; }
  .badge-healthy { background: rgba(34,197,94,0.15); color: #22c55e; }
  .badge-warning { background: rgba(245,158,11,0.15); color: #f59e0b; }
  .badge-critical { background: rgba(239,68,68,0.15); color: #ef4444; }
  .badge-info { background: rgba(99,102,241,0.15); color: #818cf8; }
  .badge-high { background: rgba(239,68,68,0.15); color: #ef4444; }
  .badge-medium { background: rgba(245,158,11,0.15); color: #f59e0b; }
  .badge-low { background: rgba(6,182,212,0.15); color: #06b6d4; }
  .badge-new { background: rgba(139,92,246,0.15); color: #a78bfa; }
  .badge-acknowledged { background: rgba(245,158,11,0.15); color: #f59e0b; }
  .badge-resolved { background: rgba(34,197,94,0.15); color: #22c55e; }
  .badge-compliant { background: rgba(34,197,94,0.15); color: #22c55e; }
  .badge-partial { background: rgba(245,158,11,0.15); color: #f59e0b; }
  .badge-non-compliant { background: rgba(239,68,68,0.15); color: #ef4444; }

  /* Tables */
  .tbl { width: 100%; border-collapse: collapse; font-size: 12px; }
  .tbl th { text-align: left; font-size: 10px; text-transform: uppercase; letter-spacing: 0.06em; color: #475569; font-weight: 600; padding: 10px; border-bottom: 1px solid #1a1f2e; }
  .tbl td { padding: 10px; border-bottom: 1px solid #0f1219; color: #94a3b8; }
  .tbl tr:hover td { background: rgba(20,24,36,0.6); }
  .tbl .num { text-align: right; font-variant-numeric: tabular-nums; }
  .tbl .clickable { cursor: pointer; }
  .tbl .clickable:hover td { background: #1a1f2e; }
  .tbl .svc-link { color: #06b6d4; cursor: pointer; font-weight: 500; }
  .tbl .svc-link:hover { text-decoration: underline; }

  /* Filter bar */
  .filter-bar { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
  .filter-bar select, .filter-bar input { padding: 6px 10px; border: 1px solid #232940; border-radius: 5px; background: #141824; color: #e2e8f0; font-size: 12px; outline: none; font-family: inherit; }
  .filter-bar select:focus, .filter-bar input:focus { border-color: #06b6d4; }

  /* Gauge */
  .gauge-wrap { display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 8px; }
  .gauge-ring { position: relative; width: 140px; height: 140px; }
  .gauge-ring canvas { width: 100%; height: 100%; }
  .gauge-label { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
  .gauge-label .val { font-size: 36px; font-weight: 700; color: #f1f5f9; line-height: 1; }
  .gauge-label .lbl { font-size: 10px; color: #64748b; text-transform: uppercase; letter-spacing: 0.06em; }

  /* Service pills */
  .svc-pills { display: flex; flex-wrap: wrap; gap: 8px; }
  .svc-pill { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: #0f1219; border: 1px solid #1a1f2e; border-radius: 6px; font-size: 11px; color: #94a3b8; }
  .svc-pill .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

  /* Chart containers */
  .chart-wrap { position: relative; width: 100%; }
  .chart-wrap canvas { width: 100%; height: 100%; display: block; }

  /* Buttons */
  .btn { padding: 5px 12px; font-size: 11px; border-radius: 5px; border: 1px solid #232940; background: #141824; color: #94a3b8; cursor: pointer; font-family: inherit; font-weight: 500; transition: all 0.15s; }
  .btn:hover { border-color: #06b6d4; color: #e2e8f0; }
  .btn-primary { background: #06b6d4; color: #fff; border-color: #06b6d4; }
  .btn-primary:hover { background: #0891b2; border-color: #0891b2; }
  .btn-sm { padding: 3px 8px; font-size: 10px; }
  .btn-back { display: inline-flex; align-items: center; gap: 4px; margin-bottom: 16px; }

  /* Compliance cards */
  .compliance-card { border-left: 3px solid transparent; }
  .compliance-card.compliant { border-left-color: #22c55e; }
  .compliance-card.partial { border-left-color: #f59e0b; }
  .compliance-card.non-compliant { border-left-color: #ef4444; }
  .compliance-title { font-size: 13px; font-weight: 600; color: #f1f5f9; margin-bottom: 4px; }
  .compliance-desc { font-size: 11px; color: #94a3b8; margin-bottom: 8px; line-height: 1.5; }
  .compliance-meta { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
  .compliance-tag { padding: 2px 8px; background: #0f1219; border-radius: 4px; font-size: 10px; color: #64748b; }
  .evidence-item { font-size: 10px; color: #475569; padding: 2px 0; }

  /* Service detail */
  .detail-header { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; flex-wrap: wrap; }
  .detail-title { font-size: 20px; font-weight: 700; color: #f1f5f9; }
  .detail-meta { font-size: 12px; color: #64748b; }
  .metric-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 16px; }
  .metric-card { background: #0f1219; border-radius: 6px; padding: 12px; }
  .metric-val { font-size: 20px; font-weight: 700; color: #f1f5f9; }
  .metric-lbl { font-size: 9px; color: #475569; text-transform: uppercase; letter-spacing: 0.06em; }

  /* Loading */
  .loading { text-align: center; padding: 60px 20px; color: #64748b; }
  .loading .spinner { width: 32px; height: 32px; border: 3px solid #1a1f2e; border-top-color: #06b6d4; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 12px; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Skeleton */
  .skeleton { background: linear-gradient(90deg, #141824 25%, #1a1f2e 50%, #141824 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 6px; }
  @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

  /* Error state */
  .error-state { text-align: center; padding: 60px 20px; }
  .error-state .icon { font-size: 32px; margin-bottom: 12px; }
  .error-state .msg { font-size: 14px; color: #ef4444; margin-bottom: 8px; }
  .error-state .sub { font-size: 12px; color: #64748b; margin-bottom: 16px; }

  /* Empty state */
  .empty-state { text-align: center; padding: 40px 20px; color: #475569; font-size: 13px; }

  /* Pulse animation for new alerts */
  @keyframes pulse-alert { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
  .pulse { animation: pulse-alert 2s ease-in-out infinite; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #1a1f2e; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #2a3650; }

  /* Responsive */
  @media (max-width: 1200px) {
    .grid-4 { grid-template-columns: 1fr 1fr; }
    .grid-5 { grid-template-columns: 1fr 1fr 1fr; }
    .grid-3 { grid-template-columns: 1fr 1fr; }
    .metric-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
  }
  @media (max-width: 768px) {
    .grid-2, .grid-3, .grid-4, .grid-5 { grid-template-columns: 1fr; }
    .tabs { flex-wrap: wrap; }
    #topbar { flex-wrap: wrap; }
  }
</style>
</head>
<body>

<div id="topbar">
  <div class="board-selector">
    <a href="/dashboard" class="board-btn">&#127959;&#65039; Architecture</a>
    <a href="/data" class="board-btn">&#128300; DataPulse</a>
    <a href="/infra" class="board-btn active">&#9881;&#65039; Infrastructure</a>
  </div>
  <div class="tabs" role="tablist" aria-label="Infrastructure sections">
    <button class="tab-btn active" data-tab="overview" role="tab" aria-selected="true" tabindex="0">Overview</button>
    <button class="tab-btn" data-tab="services" role="tab" aria-selected="false" tabindex="-1">Services</button>
    <button class="tab-btn" data-tab="costs" role="tab" aria-selected="false" tabindex="-1">Costs</button>
    <button class="tab-btn" data-tab="alerts" role="tab" aria-selected="false" tabindex="-1">Alerts</button>
    <button class="tab-btn" data-tab="anomalies" role="tab" aria-selected="false" tabindex="-1">Anomalies</button>
    <button class="tab-btn" data-tab="compliance" role="tab" aria-selected="false" tabindex="-1">Compliance</button>
  </div>
</div>

<div id="main" role="tabpanel">
  <!-- Loading state -->
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div>Loading infrastructure data...</div>
  </div>

  <!-- Error state -->
  <div id="error-state" class="error-state" style="display:none">
    <div class="icon">&#9888;&#65039;</div>
    <div class="msg" id="error-msg">Failed to load infrastructure data</div>
    <div class="sub" id="error-sub">API endpoints may be unreachable</div>
    <button class="btn btn-primary" onclick="loadAllData()">Retry</button>
  </div>

  <!-- Tab 1: Overview -->
  <div id="tab-overview" class="tab-content">
    <div class="grid grid-5" style="margin-bottom:16px" id="kpi-row"></div>
    <div class="grid grid-2" style="margin-bottom:16px">
      <div class="card card-lg">
        <div class="card-title">Health Score</div>
        <div class="gauge-wrap">
          <div class="gauge-ring"><canvas id="health-gauge" width="280" height="280"></canvas>
            <div class="gauge-label"><div class="val" id="health-val">--</div><div class="lbl">Health</div></div>
          </div>
        </div>
      </div>
      <div class="card card-lg">
        <div class="card-title">Cost Trend (Last 14 Days)</div>
        <div class="chart-wrap" style="height:200px"><canvas id="cost-trend-chart"></canvas></div>
      </div>
    </div>
    <div class="grid grid-2">
      <div class="card card-lg">
        <div class="card-title">Recent Alerts</div>
        <div id="recent-alerts-wrap"></div>
      </div>
      <div class="card card-lg">
        <div class="card-title">Service Status</div>
        <div id="svc-status-wrap"></div>
      </div>
    </div>
  </div>

  <!-- Tab 2: Services -->
  <div id="tab-services" class="tab-content">
    <div id="services-list-view">
      <div class="filter-bar" id="svc-filters">
        <select id="svc-project-filter"><option value="">All Projects</option></select>
        <select id="svc-status-filter">
          <option value="">All Statuses</option>
          <option value="active">Active</option>
          <option value="deploying">Deploying</option>
          <option value="crashed">Crashed</option>
          <option value="unknown">Unknown</option>
        </select>
        <input id="svc-search" type="search" placeholder="Search services..." aria-label="Search services">
      </div>
      <div class="card card-lg">
        <div style="overflow-x:auto">
          <table class="tbl" id="svc-table">
            <thead><tr><th>Service</th><th>Project</th><th>Status</th><th class="num">CPU%</th><th class="num">Mem%</th><th>Last Deploy</th><th class="num">Uptime</th></tr></thead>
            <tbody id="svc-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div id="service-detail-view" style="display:none"></div>
  </div>

  <!-- Tab 3: Costs -->
  <div id="tab-costs" class="tab-content">
    <div class="grid grid-3" style="margin-bottom:16px" id="cost-kpi-row"></div>
    <div class="grid grid-2" style="margin-bottom:16px">
      <div class="card card-lg">
        <div class="card-title">Daily Costs (Last 30 Days)</div>
        <div class="chart-wrap" style="height:240px"><canvas id="daily-cost-chart"></canvas></div>
      </div>
      <div class="card card-lg">
        <div class="card-title">Cost by Service</div>
        <div class="chart-wrap" style="height:240px"><canvas id="service-cost-chart"></canvas></div>
      </div>
    </div>
    <div class="card card-lg">
      <div class="card-title">Cost Forecast</div>
      <div class="chart-wrap" style="height:260px"><canvas id="forecast-chart"></canvas></div>
    </div>
  </div>

  <!-- Tab 4: Alerts -->
  <div id="tab-alerts" class="tab-content">
    <div class="filter-bar" id="alert-filters">
      <select id="alert-severity-filter">
        <option value="">All Severities</option>
        <option value="high">High</option>
        <option value="medium">Medium</option>
        <option value="low">Low</option>
      </select>
      <select id="alert-status-filter">
        <option value="">All Statuses</option>
        <option value="new">New</option>
        <option value="acknowledged">Acknowledged</option>
        <option value="resolved">Resolved</option>
      </select>
      <select id="alert-service-filter"><option value="">All Services</option></select>
    </div>
    <div class="card card-lg">
      <div style="overflow-x:auto">
        <table class="tbl" id="alert-table">
          <thead><tr><th>Time</th><th>Service</th><th>Severity</th><th>Rule</th><th>Message</th><th>Status</th><th>Action</th></tr></thead>
          <tbody id="alert-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Tab 5: Anomalies -->
  <div id="tab-anomalies" class="tab-content">
    <div class="grid grid-3" style="margin-bottom:16px" id="anomaly-stats-row"></div>
    <div class="card card-lg">
      <div class="card-title">Recent Anomalies</div>
      <div style="overflow-x:auto">
        <table class="tbl" id="anomaly-table">
          <thead><tr><th>Time</th><th>Service</th><th>Metric</th><th class="num">Value</th><th class="num">Expected</th><th class="num">Deviation</th><th>Type</th></tr></thead>
          <tbody id="anomaly-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Tab 6: Compliance -->
  <div id="tab-compliance" class="tab-content">
    <div class="grid grid-2" style="margin-bottom:16px">
      <div class="card card-lg">
        <div class="card-title">Overall Compliance Score</div>
        <div class="gauge-wrap">
          <div class="gauge-ring"><canvas id="compliance-gauge" width="280" height="280"></canvas>
            <div class="gauge-label"><div class="val" id="compliance-val">--</div><div class="lbl">Compliant</div></div>
          </div>
        </div>
      </div>
      <div class="card card-lg" id="compliance-summary"></div>
    </div>
    <div class="grid grid-2" id="compliance-grid"></div>
  </div>
</div>

<script>
(function() {
  'use strict';

  /* ─── State ─── */
  let STATE = { infra: null, alerts: null, anomalies: null, cost: null, forecast: null, compliance: null };
  let refreshTimer = null;

  /* ─── Tab System ─── */
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');

  function switchTab(tabId) {
    tabBtns.forEach(b => { b.classList.toggle('active', b.dataset.tab === tabId); b.setAttribute('aria-selected', b.dataset.tab === tabId ? 'true' : 'false'); b.tabIndex = b.dataset.tab === tabId ? 0 : -1; });
    tabContents.forEach(c => c.classList.toggle('active', c.id === 'tab-' + tabId));
    if (tabId === 'services') { document.getElementById('services-list-view').style.display = ''; document.getElementById('service-detail-view').style.display = 'none'; }
  }

  tabBtns.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));

  // Keyboard nav
  document.querySelector('.tabs').addEventListener('keydown', e => {
    const btns = [...tabBtns];
    const idx = btns.indexOf(document.activeElement);
    if (idx < 0) return;
    let next = -1;
    if (e.key === 'ArrowRight') next = (idx + 1) % btns.length;
    else if (e.key === 'ArrowLeft') next = (idx - 1 + btns.length) % btns.length;
    else if (e.key === 'Home') next = 0;
    else if (e.key === 'End') next = btns.length - 1;
    if (next >= 0) { e.preventDefault(); btns[next].focus(); btns[next].click(); }
  });

  /* ─── Utilities ─── */
  function relTime(ts) {
    if (!ts) return '--';
    const diff = Date.now() - new Date(ts).getTime();
    if (diff < 0) return 'just now';
    const s = Math.floor(diff / 1000);
    if (s < 60) return s + 's ago';
    const m = Math.floor(s / 60);
    if (m < 60) return m + 'm ago';
    const h = Math.floor(m / 60);
    if (h < 24) return h + 'h ago';
    const d = Math.floor(h / 24);
    return d + 'd ago';
  }

  function fmt(n, d) { return typeof n === 'number' ? n.toFixed(d === undefined ? 0 : d) : '--'; }
  function fmtEur(n) { return typeof n === 'number' ? '\u20AC' + n.toFixed(2) : '--'; }
  function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
  function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }

  function statusColor(s) {
    const m = { active: '#22c55e', deploying: '#f59e0b', crashed: '#ef4444', unknown: '#64748b', healthy: '#22c55e' };
    return m[(s || '').toLowerCase()] || '#64748b';
  }

  function severityClass(s) { return 'badge-' + (s || 'low').toLowerCase(); }
  function statusBadgeClass(s) { return 'badge-' + (s || 'unknown').toLowerCase().replace(/[ -]/g, '-'); }

  /* ─── Canvas Drawing Helpers ─── */
  function drawGauge(canvasId, pct, color) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    const cx = w / 2, cy = h / 2, r = Math.min(w, h) / 2 - 16;
    const startAngle = 0.75 * Math.PI;
    const endAngle = 2.25 * Math.PI;
    const sweepAngle = endAngle - startAngle;
    ctx.clearRect(0, 0, w, h);

    // Track
    ctx.beginPath();
    ctx.arc(cx, cy, r, startAngle, endAngle);
    ctx.strokeStyle = '#1a1f2e';
    ctx.lineWidth = 12;
    ctx.lineCap = 'round';
    ctx.stroke();

    // Fill
    const fillAngle = startAngle + sweepAngle * clamp(pct / 100, 0, 1);
    if (pct > 0) {
      ctx.beginPath();
      ctx.arc(cx, cy, r, startAngle, fillAngle);
      ctx.strokeStyle = color || '#06b6d4';
      ctx.lineWidth = 12;
      ctx.lineCap = 'round';
      ctx.stroke();
    }
  }

  function gaugeColor(pct) {
    if (pct >= 80) return '#22c55e';
    if (pct >= 60) return '#f59e0b';
    return '#ef4444';
  }

  function drawBarChart(canvas, data, opts) {
    if (!canvas || !data || !data.length) return;
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';
    ctx.scale(dpr, dpr);

    const W = rect.width, H = rect.height;
    const pad = { top: 10, right: 10, bottom: 30, left: 50 };
    const chartW = W - pad.left - pad.right;
    const chartH = H - pad.top - pad.bottom;

    const maxVal = Math.max(...data.map(d => d.value)) * 1.15 || 1;
    const barW = Math.max(2, (chartW / data.length) - 2);

    ctx.clearRect(0, 0, W, H);

    // Grid lines
    ctx.strokeStyle = '#1a1f2e';
    ctx.lineWidth = 0.5;
    for (let i = 0; i <= 4; i++) {
      const y = pad.top + chartH - (chartH * i / 4);
      ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
      ctx.fillStyle = '#475569'; ctx.font = '9px Inter, sans-serif'; ctx.textAlign = 'right';
      ctx.fillText(fmt(maxVal * i / 4, opts.decimals || 0), pad.left - 6, y + 3);
    }

    // Bars
    data.forEach((d, i) => {
      const x = pad.left + (chartW / data.length) * i + 1;
      const h = (d.value / maxVal) * chartH;
      const y = pad.top + chartH - h;
      ctx.fillStyle = d.color || opts.color || '#06b6d4';
      ctx.beginPath();
      const br = Math.min(3, barW / 2);
      ctx.moveTo(x, y + br);
      ctx.arcTo(x, y, x + barW, y, br);
      ctx.arcTo(x + barW, y, x + barW, y + h, br);
      ctx.lineTo(x + barW, pad.top + chartH);
      ctx.lineTo(x, pad.top + chartH);
      ctx.closePath();
      ctx.fill();

      // Labels
      if (d.label && data.length <= 31) {
        ctx.fillStyle = '#475569'; ctx.font = '8px Inter, sans-serif'; ctx.textAlign = 'center';
        ctx.fillText(d.label, x + barW / 2, H - pad.bottom + 14);
      }
    });
  }

  function drawHBarChart(canvas, data) {
    if (!canvas || !data || !data.length) return;
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';
    ctx.scale(dpr, dpr);

    const W = rect.width, H = rect.height;
    const pad = { top: 10, right: 50, bottom: 10, left: 120 };
    const chartW = W - pad.left - pad.right;
    const chartH = H - pad.top - pad.bottom;
    const barH = Math.min(24, (chartH / data.length) - 6);
    const maxVal = Math.max(...data.map(d => d.value)) * 1.1 || 1;

    ctx.clearRect(0, 0, W, H);

    data.forEach((d, i) => {
      const y = pad.top + (chartH / data.length) * i + (chartH / data.length - barH) / 2;
      const w = (d.value / maxVal) * chartW;

      // Label
      ctx.fillStyle = '#94a3b8'; ctx.font = '11px Inter, sans-serif'; ctx.textAlign = 'right';
      const label = d.label.length > 16 ? d.label.slice(0, 14) + '..' : d.label;
      ctx.fillText(label, pad.left - 8, y + barH / 2 + 4);

      // Bar
      ctx.fillStyle = d.color || '#06b6d4';
      const br = Math.min(3, barH / 2);
      ctx.beginPath();
      ctx.moveTo(pad.left, y + br);
      ctx.arcTo(pad.left, y, pad.left + w, y, br);
      ctx.arcTo(pad.left + w, y, pad.left + w, y + barH, br);
      ctx.arcTo(pad.left + w, y + barH, pad.left, y + barH, br);
      ctx.arcTo(pad.left, y + barH, pad.left, y, br);
      ctx.closePath();
      ctx.fill();

      // Value
      ctx.fillStyle = '#f1f5f9'; ctx.font = '10px Inter, sans-serif'; ctx.textAlign = 'left';
      ctx.fillText(fmtEur(d.value), pad.left + w + 6, y + barH / 2 + 4);
    });
  }

  function drawLineChart(canvas, opts) {
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';
    ctx.scale(dpr, dpr);

    const W = rect.width, H = rect.height;
    const pad = { top: 10, right: 10, bottom: 30, left: 50 };
    const chartW = W - pad.left - pad.right;
    const chartH = H - pad.top - pad.bottom;

    const allVals = [];
    (opts.lines || []).forEach(l => l.data.forEach(d => { allVals.push(d.value); if (d.upper !== undefined) allVals.push(d.upper); if (d.lower !== undefined) allVals.push(d.lower); }));
    const maxVal = (Math.max(...allVals) || 1) * 1.1;
    const minVal = Math.min(0, Math.min(...allVals));
    const range = maxVal - minVal || 1;

    ctx.clearRect(0, 0, W, H);

    // Grid
    ctx.strokeStyle = '#1a1f2e'; ctx.lineWidth = 0.5;
    for (let i = 0; i <= 4; i++) {
      const y = pad.top + chartH - (chartH * i / 4);
      ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
      ctx.fillStyle = '#475569'; ctx.font = '9px Inter, sans-serif'; ctx.textAlign = 'right';
      ctx.fillText(fmt(minVal + range * i / 4, opts.decimals || 0), pad.left - 6, y + 3);
    }

    function xPos(i, len) { return pad.left + (chartW * i / (len - 1 || 1)); }
    function yPos(v) { return pad.top + chartH - ((v - minVal) / range) * chartH; }

    (opts.lines || []).forEach(line => {
      const pts = line.data;
      if (!pts.length) return;

      // Confidence interval shading
      if (pts[0].upper !== undefined) {
        ctx.fillStyle = line.fillColor || 'rgba(6,182,212,0.08)';
        ctx.beginPath();
        ctx.moveTo(xPos(0, pts.length), yPos(pts[0].upper));
        pts.forEach((p, i) => ctx.lineTo(xPos(i, pts.length), yPos(p.upper)));
        for (let i = pts.length - 1; i >= 0; i--) ctx.lineTo(xPos(i, pts.length), yPos(pts[i].lower));
        ctx.closePath();
        ctx.fill();
      }

      // Line
      ctx.beginPath();
      ctx.moveTo(xPos(0, pts.length), yPos(pts[0].value));
      pts.forEach((p, i) => { if (i > 0) ctx.lineTo(xPos(i, pts.length), yPos(p.value)); });
      ctx.strokeStyle = line.color || '#06b6d4';
      ctx.lineWidth = line.width || 2;
      if (line.dash) ctx.setLineDash(line.dash);
      else ctx.setLineDash([]);
      ctx.stroke();
      ctx.setLineDash([]);

      // Dots
      if (pts.length < 40) {
        pts.forEach((p, i) => {
          ctx.beginPath(); ctx.arc(xPos(i, pts.length), yPos(p.value), 2.5, 0, Math.PI * 2);
          ctx.fillStyle = line.color || '#06b6d4'; ctx.fill();
        });
      }

      // Labels on x-axis
      if (line.showLabels && pts.length <= 31) {
        ctx.fillStyle = '#475569'; ctx.font = '8px Inter, sans-serif'; ctx.textAlign = 'center';
        const step = Math.ceil(pts.length / 10);
        pts.forEach((p, i) => { if (i % step === 0 && p.label) ctx.fillText(p.label, xPos(i, pts.length), H - pad.bottom + 14); });
      }
    });
  }

  /* ─── Data Loading ─── */
  async function fetchJSON(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
    return res.json();
  }

  async function loadAllData() {
    document.getElementById('loading').style.display = '';
    document.getElementById('error-state').style.display = 'none';
    tabContents.forEach(c => c.classList.remove('active'));

    try {
      const [infraRes, alertsRes, anomalyRes, costRes, forecastRes, complianceRes] = await Promise.all([
        fetchJSON('/api/monitoring/infrastructure'),
        fetchJSON('/api/monitoring/alerts'),
        fetchJSON('/api/monitoring/anomalies'),
        fetchJSON('/api/monitoring/cost'),
        fetchJSON('/api/monitoring/cost-forecast'),
        fetchJSON('/api/monitoring/compliance'),
      ]);

      STATE.infra = infraRes;
      STATE.alerts = alertsRes;
      STATE.anomalies = anomalyRes;
      STATE.cost = costRes;
      STATE.forecast = forecastRes;
      STATE.compliance = complianceRes;

      document.getElementById('loading').style.display = 'none';
      renderAll();
      switchTab('overview');
    } catch (err) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error-state').style.display = '';
      document.getElementById('error-msg').textContent = 'Failed to load infrastructure data';
      document.getElementById('error-sub').textContent = err.message || 'API endpoints may be unreachable';
    }
  }

  /* ─── Render: Overview ─── */
  function renderOverview() {
    const infra = STATE.infra || {};
    const services = infra.services || [];
    const alerts = (STATE.alerts || {}).alerts || STATE.alerts || [];
    const cost = STATE.cost || {};

    const total = services.length;
    const healthy = services.filter(s => (s.status || '').toLowerCase() === 'active').length;
    const monthlyCost = cost.total_monthly || cost.monthly_total || (cost.daily || []).reduce((a, d) => a + (d.total || d.value || 0), 0);
    const activeAlerts = (Array.isArray(alerts) ? alerts : []).filter(a => (a.status || '').toLowerCase() !== 'resolved').length;
    const avgUptime = services.length ? services.reduce((a, s) => a + (s.uptime_percent || s.uptime || 0), 0) / services.length : 0;

    const kpis = [
      { label: 'Total Services', value: total, color: '#06b6d4' },
      { label: 'Healthy Services', value: healthy, color: '#22c55e' },
      { label: 'Monthly Cost (EUR)', value: fmtEur(monthlyCost), color: '#a78bfa' },
      { label: 'Active Alerts', value: activeAlerts, color: activeAlerts > 0 ? '#ef4444' : '#22c55e' },
      { label: 'Avg Uptime %', value: fmt(avgUptime, 1) + '%', color: gaugeColor(avgUptime) },
    ];

    document.getElementById('kpi-row').innerHTML = kpis.map(k => `
      <div class="card">
        <div class="kpi-lbl">${esc(k.label)}</div>
        <div class="kpi-val" style="color:${k.color}">${k.value}</div>
      </div>
    `).join('');

    // Health gauge
    const healthPct = total ? (healthy / total * 100) : 0;
    document.getElementById('health-val').textContent = fmt(healthPct, 0) + '%';
    drawGauge('health-gauge', healthPct, gaugeColor(healthPct));

    // Cost trend mini chart
    const daily = cost.daily || cost.cost_history || [];
    const last14 = daily.slice(-14);
    if (last14.length) {
      drawLineChart(document.getElementById('cost-trend-chart'), {
        decimals: 1,
        lines: [{
          data: last14.map(d => ({ value: d.total || d.value || 0, label: (d.date || '').slice(5) })),
          color: '#a78bfa', width: 2, showLabels: true
        }]
      });
    }

    // Recent alerts
    const recentAlerts = (Array.isArray(alerts) ? alerts : []).slice(0, 5);
    const alertsWrap = document.getElementById('recent-alerts-wrap');
    if (!recentAlerts.length) {
      alertsWrap.innerHTML = '<div class="empty-state">No recent alerts</div>';
    } else {
      alertsWrap.innerHTML = `<table class="tbl"><thead><tr><th>Time</th><th>Service</th><th>Severity</th><th>Message</th></tr></thead><tbody>${recentAlerts.map(a => `
        <tr class="${(a.status || '').toLowerCase() === 'new' ? 'pulse' : ''}">
          <td>${relTime(a.timestamp || a.created_at)}</td>
          <td>${esc(a.service || a.service_name || '--')}</td>
          <td><span class="badge ${severityClass(a.severity)}">${esc(a.severity || '--')}</span></td>
          <td>${esc((a.message || '').slice(0, 60))}</td>
        </tr>
      `).join('')}</tbody></table>`;
    }

    // Service status pills
    const statusWrap = document.getElementById('svc-status-wrap');
    if (!services.length) {
      statusWrap.innerHTML = '<div class="empty-state">No services found</div>';
    } else {
      statusWrap.innerHTML = '<div class="svc-pills">' + services.map(s => `
        <div class="svc-pill"><span class="dot" style="background:${statusColor(s.status)}"></span>${esc(s.name || s.service_name || '--')}</div>
      `).join('') + '</div>';
    }
  }

  /* ─── Render: Services ─── */
  function renderServices() {
    const services = (STATE.infra || {}).services || [];
    const projects = [...new Set(services.map(s => s.project || s.project_name || 'unknown'))].sort();

    const projectFilter = document.getElementById('svc-project-filter');
    const currentVal = projectFilter.value;
    projectFilter.innerHTML = '<option value="">All Projects</option>' + projects.map(p => `<option value="${esc(p)}">${esc(p)}</option>`).join('');
    projectFilter.value = currentVal;

    // Also populate alert service filter
    const alertSvcFilter = document.getElementById('alert-service-filter');
    const alertVal = alertSvcFilter.value;
    alertSvcFilter.innerHTML = '<option value="">All Services</option>' + services.map(s => `<option value="${esc(s.name || s.service_name)}">${esc(s.name || s.service_name)}</option>`).join('');
    alertSvcFilter.value = alertVal;

    filterServices();
  }

  function filterServices() {
    const services = (STATE.infra || {}).services || [];
    const project = document.getElementById('svc-project-filter').value.toLowerCase();
    const status = document.getElementById('svc-status-filter').value.toLowerCase();
    const search = document.getElementById('svc-search').value.toLowerCase();

    const filtered = services.filter(s => {
      const sName = (s.name || s.service_name || '').toLowerCase();
      const sProject = (s.project || s.project_name || '').toLowerCase();
      const sStatus = (s.status || '').toLowerCase();
      if (project && sProject !== project) return false;
      if (status && sStatus !== status) return false;
      if (search && !sName.includes(search) && !sProject.includes(search)) return false;
      return true;
    });

    const tbody = document.getElementById('svc-tbody');
    if (!filtered.length) {
      tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No services match the current filters</td></tr>';
      return;
    }

    tbody.innerHTML = filtered.map(s => {
      const name = s.name || s.service_name || '--';
      const proj = s.project || s.project_name || '--';
      const st = (s.status || 'unknown').toLowerCase();
      return `<tr class="clickable" data-svc="${esc(name)}">
        <td class="svc-link">${esc(name)}</td>
        <td>${esc(proj)}</td>
        <td><span class="badge badge-${st}">${esc(st)}</span></td>
        <td class="num">${fmt(s.cpu_percent || s.cpu, 1)}</td>
        <td class="num">${fmt(s.memory_percent || s.memory, 1)}</td>
        <td>${relTime(s.last_deploy || s.last_deployed_at)}</td>
        <td class="num">${fmt(s.uptime_percent || s.uptime, 1)}%</td>
      </tr>`;
    }).join('');

    // Row click handlers
    tbody.querySelectorAll('.clickable').forEach(row => {
      row.addEventListener('click', () => showServiceDetail(row.dataset.svc));
    });
  }

  function showServiceDetail(svcName) {
    const services = (STATE.infra || {}).services || [];
    const svc = services.find(s => (s.name || s.service_name) === svcName);
    if (!svc) return;

    document.getElementById('services-list-view').style.display = 'none';
    const detailView = document.getElementById('service-detail-view');
    detailView.style.display = '';

    const st = (svc.status || 'unknown').toLowerCase();
    detailView.innerHTML = `
      <button class="btn btn-back" id="svc-back-btn">&larr; Back to Services</button>
      <div class="detail-header">
        <div class="detail-title">${esc(svc.name || svc.service_name)}</div>
        <span class="badge badge-${st}">${esc(st)}</span>
        <div class="detail-meta">${esc(svc.project || svc.project_name || '--')}</div>
      </div>
      <div class="metric-grid">
        <div class="metric-card"><div class="metric-val">${fmt(svc.cpu_percent || svc.cpu, 1)}%</div><div class="metric-lbl">CPU</div></div>
        <div class="metric-card"><div class="metric-val">${fmt(svc.memory_percent || svc.memory, 1)}%</div><div class="metric-lbl">Memory</div></div>
        <div class="metric-card"><div class="metric-val">${fmt(svc.uptime_percent || svc.uptime, 1)}%</div><div class="metric-lbl">Uptime</div></div>
        <div class="metric-card"><div class="metric-val">${relTime(svc.last_deploy || svc.last_deployed_at)}</div><div class="metric-lbl">Last Deploy</div></div>
        <div class="metric-card"><div class="metric-val">${svc.replicas || svc.replica_count || '--'}</div><div class="metric-lbl">Replicas</div></div>
        <div class="metric-card"><div class="metric-val">${svc.region || '--'}</div><div class="metric-lbl">Region</div></div>
      </div>
      ${svc.environment_variables ? `<div class="card card-lg" style="margin-top:16px"><div class="card-title">Environment</div><div style="font-size:11px;color:#94a3b8">${Object.entries(svc.environment_variables || {}).map(([k, v]) => `<div><span style="color:#64748b">${esc(k)}:</span> ${esc(v)}</div>`).join('')}</div></div>` : ''}
    `;

    document.getElementById('svc-back-btn').addEventListener('click', () => {
      detailView.style.display = 'none';
      document.getElementById('services-list-view').style.display = '';
    });
  }

  ['svc-project-filter', 'svc-status-filter'].forEach(id => document.getElementById(id).addEventListener('change', filterServices));
  document.getElementById('svc-search').addEventListener('input', filterServices);

  /* ─── Render: Costs ─── */
  function renderCosts() {
    const cost = STATE.cost || {};
    const forecast = STATE.forecast || {};
    const daily = cost.daily || cost.cost_history || [];

    const totalMonthly = cost.total_monthly || cost.monthly_total || daily.reduce((a, d) => a + (d.total || d.value || 0), 0);
    const projected = forecast.projected_month_end || forecast.projected_total || totalMonthly * 1.1;
    const dailyAvg = daily.length ? totalMonthly / daily.length : 0;

    document.getElementById('cost-kpi-row').innerHTML = [
      { label: 'Total Monthly Cost', value: fmtEur(totalMonthly), color: '#a78bfa' },
      { label: 'Projected Month-End', value: fmtEur(projected), color: '#06b6d4' },
      { label: 'Daily Average', value: fmtEur(dailyAvg), color: '#f1f5f9' },
    ].map(k => `<div class="card"><div class="kpi-lbl">${esc(k.label)}</div><div class="kpi-val" style="color:${k.color}">${k.value}</div></div>`).join('');

    // Project color map
    const projectColors = ['#06b6d4', '#a78bfa', '#22c55e', '#f59e0b', '#ef4444', '#ec4899', '#818cf8', '#14b8a6'];
    const projects = [...new Set(daily.flatMap(d => Object.keys(d).filter(k => k !== 'date' && k !== 'total' && k !== 'value')))];
    const projColorMap = {};
    projects.forEach((p, i) => projColorMap[p] = projectColors[i % projectColors.length]);

    // Daily cost bar chart
    const last30 = daily.slice(-30);
    if (last30.length) {
      const barData = last30.map(d => ({
        value: d.total || d.value || 0,
        label: (d.date || '').slice(8),
        color: '#06b6d4'
      }));
      drawBarChart(document.getElementById('daily-cost-chart'), barData, { decimals: 1 });
    }

    // Service cost breakdown
    const serviceCosts = cost.by_service || cost.service_breakdown || [];
    if (serviceCosts.length) {
      const hbarData = serviceCosts.slice(0, 12).map((s, i) => ({
        label: s.service || s.name || s.service_name || 'unknown',
        value: s.cost || s.total || s.value || 0,
        color: projectColors[i % projectColors.length]
      }));
      drawHBarChart(document.getElementById('service-cost-chart'), hbarData);
    }

    // Forecast line chart
    const actual = (forecast.actual || forecast.history || daily.slice(-14)).map(d => ({
      value: d.total || d.value || 0,
      label: (d.date || '').slice(5)
    }));
    const predicted = (forecast.predicted || forecast.forecast || []).map(d => ({
      value: d.total || d.value || d.predicted || 0,
      upper: d.upper || d.upper_bound || (d.total || d.value || d.predicted || 0) * 1.15,
      lower: d.lower || d.lower_bound || (d.total || d.value || d.predicted || 0) * 0.85,
      label: (d.date || '').slice(5)
    }));

    if (actual.length || predicted.length) {
      drawLineChart(document.getElementById('forecast-chart'), {
        decimals: 1,
        lines: [
          { data: actual, color: '#f1f5f9', width: 2, showLabels: true },
          { data: predicted, color: '#06b6d4', width: 2, dash: [6, 4], fillColor: 'rgba(6,182,212,0.08)', showLabels: true }
        ]
      });
    }
  }

  /* ─── Render: Alerts ─── */
  function renderAlerts() {
    filterAlerts();
  }

  function filterAlerts() {
    const allAlerts = (STATE.alerts || {}).alerts || (Array.isArray(STATE.alerts) ? STATE.alerts : []);
    const severity = document.getElementById('alert-severity-filter').value.toLowerCase();
    const status = document.getElementById('alert-status-filter').value.toLowerCase();
    const service = document.getElementById('alert-service-filter').value.toLowerCase();

    const filtered = allAlerts.filter(a => {
      if (severity && (a.severity || '').toLowerCase() !== severity) return false;
      if (status && (a.status || '').toLowerCase() !== status) return false;
      if (service && (a.service || a.service_name || '').toLowerCase() !== service) return false;
      return true;
    });

    const tbody = document.getElementById('alert-tbody');
    if (!filtered.length) {
      tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No alerts match the current filters</td></tr>';
      return;
    }

    tbody.innerHTML = filtered.map(a => {
      const sev = (a.severity || 'low').toLowerCase();
      const st = (a.status || 'new').toLowerCase();
      const isNew = st === 'new';
      return `<tr class="${isNew ? 'pulse' : ''}">
        <td>${relTime(a.timestamp || a.created_at)}</td>
        <td>${esc(a.service || a.service_name || '--')}</td>
        <td><span class="badge badge-${sev}">${esc(sev)}</span></td>
        <td>${esc(a.rule || a.rule_name || '--')}</td>
        <td>${esc((a.message || '').slice(0, 80))}</td>
        <td><span class="badge badge-${st}">${esc(st)}</span></td>
        <td>${isNew ? `<button class="btn btn-sm" onclick="acknowledgeAlert('${esc(a.id || '')}', this)">Ack</button>` : ''}</td>
      </tr>`;
    }).join('');
  }

  ['alert-severity-filter', 'alert-status-filter', 'alert-service-filter'].forEach(id => document.getElementById(id).addEventListener('change', filterAlerts));

  // Acknowledge alert (global function for inline onclick)
  window.acknowledgeAlert = async function(alertId, btnEl) {
    if (!alertId) return;
    btnEl.disabled = true;
    btnEl.textContent = '...';
    try {
      const res = await fetch('/api/monitoring/alerts/' + alertId + '/acknowledge', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
      if (!res.ok) throw new Error('Failed');
      // Update local state
      const allAlerts = (STATE.alerts || {}).alerts || (Array.isArray(STATE.alerts) ? STATE.alerts : []);
      const alert = allAlerts.find(a => a.id === alertId);
      if (alert) alert.status = 'acknowledged';
      filterAlerts();
      renderOverview();
    } catch (err) {
      btnEl.disabled = false;
      btnEl.textContent = 'Ack';
      btnEl.style.borderColor = '#ef4444';
    }
  };

  /* ─── Render: Anomalies ─── */
  function renderAnomalies() {
    const anomalies = (STATE.anomalies || {}).anomalies || (Array.isArray(STATE.anomalies) ? STATE.anomalies : []);

    // Stats
    const types = { statistical: 0, trend: 0, cost: 0 };
    anomalies.forEach(a => {
      const t = (a.type || a.anomaly_type || 'statistical').toLowerCase();
      if (t.includes('stat')) types.statistical++;
      else if (t.includes('trend')) types.trend++;
      else if (t.includes('cost')) types.cost++;
      else types.statistical++;
    });

    document.getElementById('anomaly-stats-row').innerHTML = [
      { label: 'Statistical', value: types.statistical, color: '#06b6d4' },
      { label: 'Trend', value: types.trend, color: '#a78bfa' },
      { label: 'Cost', value: types.cost, color: '#f59e0b' },
    ].map(k => `<div class="card"><div class="kpi-lbl">${esc(k.label)} Anomalies</div><div class="kpi-val" style="color:${k.color}">${k.value}</div></div>`).join('');

    // Table
    const tbody = document.getElementById('anomaly-tbody');
    if (!anomalies.length) {
      tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No anomalies detected</td></tr>';
      return;
    }

    tbody.innerHTML = anomalies.map(a => {
      const dev = Math.abs(a.deviation || a.deviation_percent || 0);
      const devColor = dev > 50 ? '#ef4444' : dev > 20 ? '#f59e0b' : '#06b6d4';
      const type = a.type || a.anomaly_type || 'statistical';
      return `<tr>
        <td>${relTime(a.timestamp || a.detected_at)}</td>
        <td>${esc(a.service || a.service_name || '--')}</td>
        <td>${esc(a.metric || a.metric_name || '--')}</td>
        <td class="num">${fmt(a.value || a.actual_value, 2)}</td>
        <td class="num">${fmt(a.expected || a.expected_value, 2)}</td>
        <td class="num" style="color:${devColor}">${fmt(dev, 1)}%</td>
        <td><span class="badge badge-info">${esc(type)}</span></td>
      </tr>`;
    }).join('');
  }

  /* ─── Render: Compliance ─── */
  function renderCompliance() {
    const compliance = STATE.compliance || {};
    const requirements = compliance.requirements || compliance.items || compliance.nis2 || [];
    const score = compliance.overall_score || compliance.score || 0;

    // Gauge
    document.getElementById('compliance-val').textContent = fmt(score, 0) + '%';
    drawGauge('compliance-gauge', score, gaugeColor(score));

    // Summary
    const counts = { compliant: 0, partial: 0, 'non-compliant': 0 };
    requirements.forEach(r => {
      const st = (r.status || '').toLowerCase().replace(/[ _]/g, '-');
      if (counts[st] !== undefined) counts[st]++;
    });

    document.getElementById('compliance-summary').innerHTML = `
      <div class="card-title">NIS2 Compliance Summary</div>
      <div style="display:flex;flex-direction:column;gap:12px;margin-top:8px">
        <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:12px;color:#94a3b8">Compliant</span><span class="badge badge-compliant">${counts.compliant}</span></div>
        <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:12px;color:#94a3b8">Partial</span><span class="badge badge-partial">${counts.partial}</span></div>
        <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:12px;color:#94a3b8">Non-Compliant</span><span class="badge badge-non-compliant">${counts['non-compliant']}</span></div>
        <div style="display:flex;justify-content:space-between;align-items:center;border-top:1px solid #1a1f2e;padding-top:8px"><span style="font-size:12px;color:#94a3b8">Total Requirements</span><span style="font-size:14px;font-weight:700;color:#f1f5f9">${requirements.length}</span></div>
      </div>
    `;

    // Requirement cards
    const grid = document.getElementById('compliance-grid');
    if (!requirements.length) {
      grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1">No compliance data available</div>';
      return;
    }

    grid.innerHTML = requirements.map(r => {
      const st = (r.status || '').toLowerCase().replace(/[ _]/g, '-');
      const services = r.services || r.mapped_services || [];
      const evidence = r.evidence || r.evidence_items || [];
      return `<div class="card card-lg compliance-card ${st}">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px">
          <div style="font-size:10px;color:#475569;font-weight:600">${esc(r.article || r.article_number || '--')}</div>
          <span class="badge badge-${st}">${esc(st.replace(/-/g, ' '))}</span>
        </div>
        <div class="compliance-title">${esc(r.title || r.name || '--')}</div>
        <div class="compliance-desc">${esc(r.description || '')}</div>
        ${services.length ? `<div class="compliance-meta">${services.map(s => `<span class="compliance-tag">${esc(s)}</span>`).join('')}</div>` : ''}
        ${evidence.length ? `<div style="margin-top:8px">${evidence.map(e => `<div class="evidence-item">${esc(typeof e === 'string' ? e : e.name || e.title || '')}</div>`).join('')}</div>` : ''}
        ${r.last_audit ? `<div style="font-size:10px;color:#475569;margin-top:8px">Last audit: ${relTime(r.last_audit)}</div>` : ''}
      </div>`;
    }).join('');
  }

  /* ─── Render All ─── */
  function renderAll() {
    renderOverview();
    renderServices();
    renderCosts();
    renderAlerts();
    renderAnomalies();
    renderCompliance();
  }

  /* ─── Auto Refresh ─── */
  function startAutoRefresh() {
    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(() => {
      loadAllData();
    }, 60000);
  }

  /* ─── Resize handler ─── */
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      if (STATE.infra) renderAll();
    }, 250);
  });

  /* ─── Init ─── */
  loadAllData();
  startAutoRefresh();

})();
</script>
</body>
</html>